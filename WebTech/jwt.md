# JWT

일반적인 토큰의 흐름을 생각한다면 API 요청 시에 들어온 토큰을 보고 이 토큰이 유효한지 확인하게 된다. 보통은 데이터베이스에 토큰을 저장해 놓고 만료시간이나 토큰의 사용자 등을 저장해 놓고 유효한 토큰인지 등을 검사하고 유효한 경우 해당 사용자라고 인식하고 이 사용자의 권한으로 사용할 수 있는 정보를 조회하게 된다. 요청마다 데이터베이스를 조회하는 것은 비용이 꽤 크므로 캐시서버 등을 두어 성능을 높이기도 한다.

JWT의 경우는 토큰을 받아서 서명으로 유효한 토큰인지 검증을 한 뒤에 유효하다고 판단하면 클레임셋을 디코딩해서 토큰에 담긴 데이터를 열어본다. 앞에서 보았듯이 클레임셋의 JSON에 만료시간 등이 담겨있으므로 토큰이 사용가능한지 검사를 하고 이상이 없으면 바로 사용한다. 토큰의 사용자 아이디 등이 클레임셋에 담겨있다면 데이터베이스나 캐시를 조회할 필요없이 바로 애플레이케션이서 사용자를 확인하고 정보를 조회할 수 있다. 대신 다른 토큰보다 길이가 좀 길다는 문제는 있다.

이 차이는 서버 개발 쪽에서는 상당히 큰 차이를 만들어내는데 토큰만 가지고 유효성 검사나 사용자 식별까지 할 수 있으므로 서버를 무상태로 유지할 수 있다는 점이다. 데이터베이스나 캐시 없이 로직만으로 인증이 가능하므로 애플리케이션 서버를 필요에 따라 늘릴 수 있다.

권한 토큰 방식으로 토큰 발급

엑세스 토큰을 Header에 붙여서 API 접근
Authorization: Bearer 발급된AccessToken

발급된 토큰을 메모리에 저장하면 멀티 서버 환경에서 작동하지않음.
TokenStore라는 토큰을 저장하는 인터페이스정의.

Spring Security OAuth2의 기본 TokenStore 종류
1. org.springframework.security.oauth2.provider.token.store.InmemoryTokenStore
- JAVA 내부에서 Map, Queue 구조의 메모리를 사용한 저장소
2. JdbcTokenStore
- JDBC를 사용해서 DB에 저장하는 방식
3. JwtTokenStore
- 외부저장소가 아닌 JWT를 이용하는 방식
4. RedisTokenStore
- redis(Key value 저장소)에 token을 저장하는 방식

기본 설정은 InmemoryTokenStore이므로 서버가 리붓되면 날아간다.

JwtTokenStore 은 JWT 형태로 OAuth2 인증을 받게하는 형태
먼저 JWT를 사용하기 위해서는 OAuth2-server, api-server에 security-jwt 의존성이 추가되어야한다.

JWT 토큰 암호화 키 값이 필요하다. (서명키값)

JWT 토큰 자체에 유저정보가 들어있으므로 JSON을 해석해서 토큰 정보를 읽어 오게 된다.

클라리언트 관리도 필요하다.
