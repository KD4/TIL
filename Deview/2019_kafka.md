11번가 kafka
==================================


11번가는 하나의 모노리틱 프로젝트

MSA으로의 전환

모노리틱 서비스를 뜯어냄

Greenwich?

마이크로 서비스의 전환은 서비스의 성장과 새로운 문제의 출현

트래픽의 성장과 시스템의 성장이 꼭 필요했음

트래픽 성장에 따라서 DB가 병목됐다.

주문, 결제의 데이터베이스 부하

하나의 주문 트랙잭션이 크다.  주문 트랙잭션에서 트랙잭션에 필요없는 작업은 이벤트로 만든다.

트랙잭션의 분리, 구간별 아키텍쳐의 분리

카프카 활용

컨슈머 그룹 컨슈머의 집합. 여러개의 파티션으로 분할된 토픽을 파티션별로 할당받아 메시지를 처리

리밸런스
컨슈머 그룹안에 새로운 컨슈머가 추가되면 담당 파티션을 재조정하는 작업
이 작업이 일어나면 전체 컨슈머가 메시지 수신을 잠시 멈춤

컨슈머 애플리케이션 배포
카프카를 활용하는 서비스를 배포한다면? Blue/Green 불가

1번 서버를 배포하면 리밸런스가 일어나 서비스가 중단됨, 2번서버 3번서버가 롤링 업데이트될때마다 컨슈머 전체가 중단됨. => 우아한 배포 불가
WAS1의 장애가 다른 WAS들도 장애가 일어난다.

EDA 게이트웨이?
컨슈머 게이트웨이를 따로 두었다. 배포주기가 길다


## 응답 메시지의 처리
기존에는 결제 요청이 결제 성공/실패ㅐ

이벤트 드리븐은 결제 요청을 보내면 카프카에 저장이 된 것만 안다.

모든 메시지를 파티션별로 컨슈머를 나눈다?

## 백프레셔

카프카는 Polling 메시지의 처리가 끝나야된다.

파티션의 수에 의존적

컨슈머 스레드와 워커 스레드를 분리


## 메시지 유실 - 모니터링
이벤트 드리븐에서 메시지 유실이 필연적
메시지 유실된건지, 늦게 처리된 것인지 모른다.
하나의 주문이 5분간 기다려 응답이 오지 않으면 문제가 있다;


Kafka Stream에서 데이터를 쿼리하는 방법 StateSoure

StateStore는 컨슈머 그룹안에서 동작한다.

특정 데이터는 특ㄱ정 그룹에만..


## 새로운 시스템 모니터링

메시지 흐름을 볼 수 있는 모니터링> Zipkin Brave? 카프카 ID에 스킴을 넣는다.

뭐야..

##
