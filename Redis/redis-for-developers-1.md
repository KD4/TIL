
# 마이크로서비스 아키텍처와 레디스

소프트웨어의 아키텍처는 중앙 집약적인 모놀리틱 아키텍처에서 마이크로서비스 아키텍처로 점차 변화하고 있다. 이에 따라 데이터 저장소의 특징 역시 다양하게 발전해왔다. 과거 모놀리틱 아키텍처에서는 관계 집약적인 데이터를 하나의 서비스로 관리하기 때문에 관계형 데이터베이스가 주 데이터 매니지먼트 시스템으로 굳어져왔지만 마이크로 서비스에서 각 서비스는 각각 하나의 역할을 수행하기 위해 설계된 독립적인 파트이기 때문에, 서비스별 비즈니스 특성과 데이터의 형태를 고려해 관계형 데이터베이스 또는 NoSQL 데이터베이스를 선택해서 사용할 수 있게 됐다.

## NoSQL이란?
NoSQL이란 용어는 No SQL 혹은 Not Only SQL을 의미한다. SQL은 standard query language란 의미로 관계형 데티어베이스에서 사용하는 쿼리를 뜻한다. NoSQL은 일반적으로 더 빠른 응답, 나은 확장성, 고가용성, 단순성, 유연성 등의 특징이 있다. 
NoSQL도 다양한 유형이 있는데 각각 유형을 살펴보자.

### 그래프 유형
그래프 유형의 데이터베이스는 엔티티 간의 관계를 효율적으로 저장하도록 설계됐다. 이 유형에서는 노드, 엣지, 속성으로 데이터를 나타내고 데이터의 엔티티는 노드로 표현하며 데이터 사이의 관계를 에지로 나타낸다. 에지는 상항 시작 노드, 끝 노드, 유형과 방향을 가지며 상-하위 관계, 동작, 소유자 등의 정보를 저장한다. 

그래프 유형의 데이터베이스는 관계를 저장하고 표현할 대 유용하게 사용될 수 있으며, 저장되는 속성의 크기가 크거나 매우 많은 속성을 저장할 때는 적합하지 않을 수 있다. 

추천 서비스나 SNS 친구 관계를 나타낼 때 유용하게 사용할 수 있다.

### 칼럼 유형
칼럼 유형의 NoSQL은 테이블을 행이 아닌 열 기준으로 저장한다는 철학으로 설계됐다. 데이터는 하나의 열에 중첩된 키-값 형태로 저장될 수 있기 때문에 기존의 관계형 데이터베이스와 비교했을 때보다 유연한 스키마를 저장할 수 있다.

또한 대량의 데이터에 대한 집계 쿼리를 다른 유형보다 훨씬 빠르게 처리할 수 있어 분석, 보고, 빅데이터 처리에 적합하며 대표적인 데이터베이스로는 Cassandra, HBase 등이 있다.
https://dataonair.or.kr/db-tech-reference/d-lounge/expert-column/?mod=document&uid=52606

### 문서 유형
문서 유형의 데이터베이스는 JSON 형태로 데이터가 저장돼, 개발자들이 편하게 사용할 수 있는 구조다. 

또한 스키마가 정해져 있지 않기 때문에 애플리케이션에 맞게 데이터를 그대로 저장할 수 있어 유연성이 크다는 장점이 존재한다. 

데이터를 저장하거나 검색하는데 효과적이며 대표적인 데이터베이스로는 MongoDB, CouchDB, DocumentDB가 있다.

### 키-값 유형
키-값 유형은 가장 단순하고 빠르다. 키값 유형에서 키는 관계형 디비의 PK라고도 생각할 수 있다. 다른 디비보다 빠른 응답속도를 보장하며 대표적인 데이터베이스로는 Redis, ElastiCache, DynamoDB, Memcached가 있다.

## Redis란?
Remote dictionary server 의 약자인 레디스는 고성능 키-값 유형의 인메모리 NoSQL 데이터베이스로, 오픈 소스 기반의 데이터 저장소다.

### 레디스의 특징
레디스의 특징은 실시간 응답, 단순성, 고가용성, 확장성 등이 있는데 어떻게 이런 특징을 가지게 됐는지 자세히 봐보자.

#### 실시간 응답(빠른 성능)
레디스는 인메모리 데이터베이스로 온디스크 데이터베이스와는 다르게 모든 데이터가 컴퓨터의 메모리에서 관리된다. 디스크에 접근하는 과정이 필요 업식 때문에 데이터 처리 성능이 굉장히 빠르다는 장점을 갖고 있다.

#### 단순성
레디스는 키-값 형태로 데이터를 저장할 수 있는 데이터 저장소다. 레디스에 저장되는 값들은 문자열 뿐만 아니라 해시, 셋 등 복잡하고 다양한 자료 구조를 저장할 수 있고 이는 애플리케이션에서 쉽게 사용할 수 있다.
임피던스 불일치는 기존 관계형 데이터베이스의 테이블 구조와 프로그래밍 언어에서 사용하는 자료 구조의 구조, 기능적 차이로 인해 발생하는 충돌을 의미하는데, 레디스에서는 임피던스 불일치가 최소화된다.

레디스는 이벤트 루프로 동작하는 싱글 스레드 데이터베이스이다. 실제로는 메인 스레드 1개와 별도의 스레드 3개, 총 4개가 동작하지만 클리언트 커맨드를 처리하는 부분은 싱글 스레드로 동작한다. 
이 때문에 동시성으로 인한 동기화 처리가 필요 없어서 매우 빠르고 안정적으로 사용자 커멘드를 처리할 수 있지만 하나의 커멘드가 너무 오래 걸린다면 다른 쿼리들이 대기하는 불상사가 벌어지게 된다. (이렇기 때문에 설정으로 너무 오래 걸리는 쿼리(Keys 등)은 막아둔다)

#### 고가용성
레디스는 자체적으로 HA(High Availability) 기능을 제공한다. 복제를 통해 데이터를 여러 서버에 분산시킬 수 있으며 센티널은 장애 상황을 탐지해 자동으로 페일오버를 시켜준다. 

#### 확장성
레디스에서 클러스터 모드를 사용한다면 손쉬운 수평적 확장이 가능하다. 데이터는 레디스 클러스터 내에서 자동으로 샤딩된 후 저장되며 여러 개의 복제본이 생성될 수 있다. 클러스터 구조에서 모든 레디스 인스턴스는 클러스터 버스라는 프로토콜을 이용해 서로 감시하고 있으며 이를 이용해 클러스터의 마스터 노드에 문제가 발생하면 자동으로 페일오버를 시켜 고가용성을 유지할 수 있다.


## 마이크로서비스 아키텍처와 레디스
더 이상 관계형 데이터베이스만으로는 현대 제품에서 요구되는 모든 기능을 커버할 수 없으며, 이와 같은 요구사항을 커버하기 위해서 Redis를 활용해야한다.

#### 데이터 저장소로서의 레디스
레디스는 메모리에 있는 데이터가 영구 저장되지 않기 때문에 데이터 저장소로 영속성을 고민할 수 있으나, 레디스의 데이터는 AOF(Append Only File)와 RDB(Redis Database) 형식으로 디스크에 주기적으로 저장할 수 있다.
(일종의 백업, 완전하지는 않음)

#### 메시지 브로커로서의 레디스
레디스는 Pub/Sub 기능을 통해서 이벤트를 브로드캐스팅할 수 있고(캐시 expire 사용 가능) list 자료 구조를 사용해 메시징 큐로 사용할 수 있다. (카프카 lag 해소를 임시로 해결) 또 레디스의 Stream 구조를 이용하면 카프카처럼 소비자 그룹에게 일괄 분산 처리도 가능하다.